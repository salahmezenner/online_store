{% extends 'base.html' %}

{% block title %}Your Cart{% endblock %}

{% block content %}
<h2 class="section-title">Your cart</h2>

{% if cart %}
<table class="table align-middle">
  <thead>
    <tr>
      <th>Product</th>
      <th style="width: 120px;">Quantity</th>
      <th>Price</th>
      <th>Total</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in cart %}
    <tr data-product="{{ item.product.id }}">
      <td>{{ item.product.title }}</td>

      <td>
        <input type="number"
               class="form-control form-control-sm qty-input text-center"
               value="{{ item.quantity }}"
               min="1"
               max="{{ item.product.stock }}"
               style="width:80px;">
      </td>

      <td>${{ item.price }}</td>
      <td class="item-total">${{ item.total }}</td>
      <td><a href="{% url 'cart:cart_remove' item.product.id %}" class="btn btn-sm btn-outline-dark rounded-pill px-3">Remove</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="d-flex justify-content-end">
  <div class="text-end" style="max-width: 240px;">
    <div class="d-flex justify-content-between">
      <span class="text-muted">Subtotal</span>
      <span>$<span id="cart-total">{{ cart.get_total_price }}</span></span>
    </div>
  </div>
</div>

<div class="text-end">
  <a href="{% url 'checkout:order_create' %}" class="btn btn-outline-dark rounded-pill px-4">Proceed to checkout</a>
</div>

{% else %}
<p class="text-center">Your cart is empty. <a href="/">Go shopping!</a></p>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const inputs = document.querySelectorAll('.qty-input');

  inputs.forEach(input => {
    input.addEventListener('change', async () => {
      const row = input.closest('tr');
      const productId = row.dataset.product;
      const quantity = input.value;

      const response = await fetch(`/cart/update_ajax/${productId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: new URLSearchParams({ quantity })
      });

      if (response.ok) {
        const data = await response.json();
        // Update item total
        row.querySelector('.item-total').textContent = `$${data.item_total}`;
        // Update cart total
        document.getElementById('cart-total').textContent = data.cart_total;
      }
    });
  });
});
</script>
{% endblock %}
