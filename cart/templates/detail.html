{% extends 'base.html' %}

{% block title %}Your Cart{% endblock %}

{% block content %}
<h2 class="mb-4 text-center">Your Shopping Cart</h2>

{% if cart %}
<table class="table table-striped align-middle">
  <thead class="table-dark">
    <tr>
      <th>Product</th>
      <th style="width: 120px;">Quantity</th>
      <th>Price</th>
      <th>Total</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in cart %}
    <tr data-product="{{ item.product.id }}">
      <td>{{ item.product.title }}</td>

      <td>
        <input type="number"
               class="form-control form-control-sm qty-input text-center"
               value="{{ item.quantity }}"
               min="1"
               max="{{ item.product.stock }}"
               style="width:80px;">
      </td>

      <td>${{ item.price }}</td>
      <td class="item-total">${{ item.total }}</td>
      <td><a href="{% url 'cart:cart_remove' item.product.id %}" class="btn btn-sm btn-danger">Remove</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h4 class="text-end">Total: $<span id="cart-total">{{ cart.get_total_price }}</span></h4>

<div class="text-end">
  <a href="{% url 'checkout:order_create' %}" class="btn btn-success">Proceed to Checkout</a>
</div>

{% else %}
<p class="text-center">Your cart is empty. <a href="/">Go shopping!</a></p>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const inputs = document.querySelectorAll('.qty-input');

  inputs.forEach(input => {
    input.addEventListener('change', async () => {
      const row = input.closest('tr');
      const productId = row.dataset.product;
      const quantity = input.value;

      const response = await fetch(`/cart/update_ajax/${productId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: new URLSearchParams({ quantity })
      });

      if (response.ok) {
        const data = await response.json();
        // Update item total
        row.querySelector('.item-total').textContent = `$${data.item_total}`;
        // Update cart total
        document.getElementById('cart-total').textContent = data.cart_total;
      }
    });
  });
});
</script>
{% endblock %}
